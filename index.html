<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="robots" content="noindex">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Analysis Dashboard - Jul/25</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
            color: #1f2937;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            height: 50vh;
            max-height: 460px;
        }
        .small-chart-container {
            position: relative;
            width: 100%;
            height: 250px;
        }
        .nav-button {
            transition: all 0.3s ease;
            border-bottom: 4px solid transparent;
        }
        .nav-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
        }
        .kpi-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .value-positive { color: #10b981; }
        .value-negative { color: #ef4444; }
        
        #loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 9999;
        }

        @media print {
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            header, #print-button {
                display: none !important;
            }
            main {
                padding-top: 0 !important;
            }
            .kpi-card, .bg-white {
                box-shadow: none !important;
                border: 1px solid #e5e7eb;
            }
            .bg-white {
                page-break-inside: avoid;
            }
            .chart-container {
                height: 280px !important;
                max-height: 350px !important;
            }
            .small-chart-container {
                 height: 200px !important;
            }
            #view-flash, #view-forecast {
                display: block !important;
            }
            .page-break {
                page-break-after: always;
            }
        }
    </style>
</head>
<body class="antialiased">
    <div id="loader" class="flex justify-center items-center">
        </div>

    <div id="app" class="min-h-screen">
        <header class="bg-white shadow-sm sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-col sm:flex-row justify-between items-center py-4">
                    <h1 class="text-2xl font-bold text-gray-800 mb-4 sm:mb-0">Financial Analysis Dashboard - Jul/25</h1>
                    <div class="flex items-center space-x-4">
                        <button id="print-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition">
                            Print to PDF
                        </button>
                    </div>
                </div>
                <nav class="flex border-b border-gray-200">
                    <button id="btn-flash" class="nav-button py-4 px-6 text-lg font-semibold text-gray-500">Flash vs. Actual</button>
                    <button id="btn-forecast" class="nav-button py-4 px-6 text-lg font-semibold text-gray-500">Forecast vs. Actual</button>
                </nav>
            </div>
        </header>

        <main class="py-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div id="view-flash">
                    <div id="flash-kpis" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"></div>
                    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-md mb-8">
                        <h2 class="text-xl font-semibold text-gray-700 mb-2">Net Income Waterfall: Flash vs. Actual (R$ '000)</h2>
                        <p class="text-gray-500 mb-6">This chart breaks down the difference between the Flash Closing and the final Actual Net Income, showing how each major financial category contributed to the total variance.</p>
                        <div class="chart-container"><canvas id="flashWaterfallChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-md mb-8">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Income Statement Analysis: Flash vs. Actual</h2>
                        <div class="overflow-x-auto"><table id="flash-income-table" class="min-w-full text-sm"></table></div>
                    </div>
                    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-md mb-8">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Where did we miss? Flash vs. Actual</h2>
                        <div class="overflow-x-auto"><table id="flash-miss-table" class="min-w-full text-sm"></table></div>
                    </div>
                    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-md mb-8 page-break">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Take-Aways: Flash vs. Actual</h2>
                        <div id="flash-takeaways" class="space-y-4"></div>
                    </div>
                    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-md mb-8 page-break">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Key Operational Metrics Progression</h2>
                        <p class="text-gray-500 mb-6">These charts show the journey of key metrics from the initial forecast, to the preliminary flash report, and finally to the actual result, highlighting performance trends and deviations at each stage.</p>
                        <div id="flash-op-metrics" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
                    </div>
                    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-md">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Flash Closing Accuracy</h2>
                        <p class="text-gray-500 mb-6">This section measures how close the final Actual results were to the Flash Closing figures, providing a quantitative assessment of the preliminary closing process's reliability.</p>
                        <div id="flash-accuracy-kpis" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4"></div>
                    </div>
                </div>

                <div id="view-forecast" class="hidden">
                     <div id="forecast-kpis" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"></div>
                    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-md mb-8">
                        <h2 class="text-xl font-semibold text-gray-700 mb-2">Net Income Waterfall: Forecast vs. Actual (R$ '000)</h2>
                        <p class="text-gray-500 mb-6">This chart breaks down the difference between the Forecast and the final Actual Net Income, showing how each major financial category contributed to the total variance.</p>
                        <div class="chart-container"><canvas id="forecastWaterfallChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-md mb-8">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Income Statement Analysis: Forecast vs. Actual</h2>
                        <div class="overflow-x-auto"><table id="forecast-income-table" class="min-w-full text-sm"></table></div>
                    </div>
                    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-md mb-8">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Where did we miss? Forecast vs. Actual</h2>
                        <div class="overflow-x-auto"><table id="forecast-miss-table" class="min-w-full text-sm"></table></div>
                    </div>
                    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-md mb-8 page-break">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Take-Aways: Forecast vs. Actual</h2>
                        <div id="forecast-takeaways" class="space-y-4"></div>
                    </div>
                    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-md mb-8 page-break">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Key Operational Metrics Progression</h2>
                        <p class="text-gray-500 mb-6">These charts show the journey of key metrics from the initial forecast, to the preliminary flash report, and finally to the actual result, highlighting performance trends and deviations at each stage.</p>
                        <div id="forecast-op-metrics" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
                    </div>
                    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-md">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Forecast Accuracy</h2>
                        <p class="text-gray-500 mb-6">This section measures how close the final Actual results were to the Forecast figures, providing a quantitative assessment of the forecasting process's reliability.</p>
                        <div id="forecast-accuracy-kpis" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        Chart.register(ChartDataLabels);

        const btnFlash = document.getElementById('btn-flash');
        const btnForecast = document.getElementById('btn-forecast');
        const viewFlash = document.getElementById('view-flash');
        const viewForecast = document.getElementById('view-forecast');
        const printButton = document.getElementById('print-button');
        
        let flashWaterfallChart, forecastWaterfallChart;
        let opCharts = {};
        let currentView = 'flash';

        const initialReportData = {
            flash: {
                kpis: { closing: 55866, actual: 55847, variance: -19 },
                waterfall: { labels: ['Flash Closing', 'Payments', 'Credit', 'Banking', 'Other Rev', 'Funding Cost', 'Selling Exp', 'Other Costs', 'Taxes', 'Actual'], data: [{v:55866,t:'t'},{v:4429,t:'d'},{v:232,t:'d'},{v:1545,t:'d'},{v:114,t:'d'},{v:-499,t:'d'},{v:-2056,t:'d'},{v:474,t:'d'},{v:-4258,t:'d'},{v:55847,t:'t'}] },
                incomeTable: [
                    { item: '1. Net revenue', delta: '+6.32mn', driver: 'Acquiring Revenue (MDR + anticipation) +4.4mn, and Interest on Deposits +1.5mn.' },
                    { item: '2. Cost of POS sold', delta: '+1.42mn', driver: 'Driven by lower Hardware cost (+0.65mn) and lower sales incentives (+0.73mn).' },
                    { item: '3. Cost of service', delta: '-3.22mn', driver: 'Higher operational software expenses (-1.51mn), credit-loss allowance (-1.2mn), and issuing costs (-0.98mn).' },
                    { item: 'Gross profit (before funding cost)', delta: '+4.52mn', driver: 'Sum of the three rows above.', isBold: true, isSub: true },
                    { item: '4. SG&A (Selling + Admin)', delta: '-0.83mn', driver: 'Higher marketing expenses (-2.1mn) were partly offset by other savings.' },
                    { item: '5. Net financial result', delta: '+0.55mn', driver: 'Better yield on investments (+1.50mn), offset by higher funding cost (-0.50mn) and banking fees (-0.62mn).' },
                    { item: '6. Taxes', delta: '-4.26mn', driver: 'Effective tax rate 37.6% vs 34.5% in the flash.' },
                    { item: 'Net income variance', delta: '-0.02mn', driver: 'Actual 55.85mn vs Flash 55.87mn.', isBold: true, isTotal: true }
                ],
                missTable: [
                    { bucket: 'Acquiring Revenue', impact: '+4.93mn', share: '-25947%' },
                    { bucket: 'Interest-income lift & Net financial result', impact: '+2.33mn', share: '-12263%' },
                    { bucket: 'Higher income-tax expense', impact: '-4.26mn', share: '22421%' },
                    { bucket: 'Variable operating costs', impact: '-1.62mn', share: '8526%' },
                    { bucket: 'SG&A & other operating items', impact: '-0.83mn', share: '4368%' }
                ],
                takeaways: [
                    { title: '1. Topline strength driven by acquiring revenues', text: 'A significant beat on acquiring take rate (+$4.43mn) and interest on deposits (+$1.54mn) drove the revenue upside.' },
                    { title: '2. Higher variable and operational costs', text: 'Increased costs were driven by a prudent increase in credit-loss allowance (-$1.9mn) and higher marketing spend (-$2.1mn), which offset some of the revenue gains.' },
                    { title: '3. Higher taxes seal the small gap', text: 'A higher effective tax rate of 37.6% (vs. 34.5% in flash) resulted in a -$4.3mn negative impact, wiping out the operational gains.' }
                ]
            },
            forecast: {
                kpis: { closing: 50141, actual: 55847, variance: 5705 },
                waterfall: { labels: ['Forecast', 'Payments', 'Credit', 'Banking', 'Other Rev', 'Funding Cost', 'Selling Exp', 'Other Costs', 'Taxes', 'Actual'], data: [{v:50141,t:'t'},{v:21145,t:'d'},{v:3971,t:'d'},{v:2745,t:'d'},{v:80,t:'d'},{v:-12844,t:'d'},{v:-4980,t:'d'},{v:451,t:'d'},{v:-4862,t:'d'},{v:55847,t:'t'}] },
                incomeTable: [
                    { item: '1. Net revenue', delta: '+27.94mn', driver: 'Acquiring Revenue (+21.14mn), Interest on loans (+3.97mn), and Interest on Deposits (+2.75mn).' },
                    { item: '2. Cost of POS sold', delta: '+1.21mn', driver: 'Lower sales incentives (+1.27mn) offset higher unit cost (-0.25mn).' },
                    { item: '3. Cost of service', delta: '-6.48mn', driver: 'Heavier cloud/data-processing cost (-2.38mn), higher credit-loss allowance (-2.98mn), and higher chargeback-loss allowance (-2.29mn).' },
                    { item: 'Gross profit (before funding cost)', delta: '+22.67mn', driver: 'Sum of the three rows above.', isBold: true, isSub: true },
                    { item: '4. SG&A (Selling + Admin)', delta: '-4.61mn', driver: 'Marketing overspend (-5.08mn) was the main driver.' },
                    { item: '5. Net financial result', delta: '-7.49mn', driver: 'Higher anticipation funding cost (-12.84mn) due to higher TPV, partly offset by a favorable FX swing (+6.05mn).' },
                    { item: '6. Taxes', delta: '-4.86mn', driver: 'Effective rate 37.6% vs 36.5% in the forecast.' },
                    { item: 'Net income variance', delta: '+5.70mn', driver: 'Actual 55.85mn vs Forecast 50.14mn.', isBold: true, isTotal: true }
                ],
                missTable: [
                    { bucket: 'Acquiring Revenue (MDR + Antic.)', impact: '+20.85mn', share: '366%' },
                    { bucket: 'Interest-income lift (loans + deposits)', impact: '+6.72mn', share: '118%' },
                    { bucket: 'Net financial result (FX & funding cost)', impact: '-7.49mn', share: '-131%' },
                    { bucket: 'Variable operating costs', impact: '-6.69mn', share: '-117%' },
                    { bucket: 'SG&A & other items (marketing)', impact: '-4.61mn', share: '-81%' },
                    { bucket: 'Higher income-tax expense', impact: '-4.86mn', share: '-85%' }
                ],
                takeaways: [
                    { title: '1. Strong revenue performance (R$ 27.9mn) drives the beat', text: 'A significant upside in acquiring revenues (+$21.1mn) and interest income from both loans and deposits (+$6.7mn) greatly surpassed the forecast.' },
                    { title: '2. Higher funding and operational costs eroded gains', text: 'Strong revenue from anticipation came with higher funding costs (-$12.8mn). This, combined with increased marketing spend (-$5.1mn) and larger provisions (-$4.6mn), consumed a large portion of the revenue upside.' },
                    { title: '3. Favorable FX provided a partial cushion', text: 'An unexpected FX gain of +$6.0mn helped to offset some of the increased costs, contributing positively to the bottom line.' }
                ]
            },
            operational: {
                tpv: { label: 'TPV', forecast: 7906015, flash: 8176584, actual: 8176584 },
                activeBase: { label: 'Active Base', forecast: 4262088, flash: 4298206, actual: 4298206 },
                creditBalance: { label: 'Credit Balance', forecast: 237977, flash: 304776, actual: 303655 },
                customerDeposits: { label: 'Customer Deposits', forecast: 1400920, flash: 1380277, actual: 1380277 },
                costFunding: { label: 'Cost of Funding', forecast: -243425, flash: -255770, actual: -256269 },
                sellingExpenses: { label: 'Selling Expenses', forecast: -61944, flash: -64868, actual: -66924 },
                costServices: { label: 'Cost of Services', forecast: -69696, flash: -73166, actual: -74969 },
                adminExpenses: { label: 'Admin Expenses', forecast: -8813, flash: -9186, actual: -8879 },
                netIncome: { label: 'Net Income', forecast: 50141, flash: 55866, actual: 55847 }
            }
        };

        const formatCurrency = (value) => `R$ ${value.toLocaleString('en-US')}`;
        
        const renderKPIs = (view, data) => {
            const container = document.getElementById(`${view}-kpis`);
            const isFlash = view === 'flash';
            const closingLabel = isFlash ? 'Net Income Flash Closing' : 'Net Income Forecast';
            container.innerHTML = `
                <div class="kpi-card text-center"><p class="text-sm font-medium text-gray-500">${closingLabel} (R$ '000)</p><p class="text-3xl font-bold text-gray-800">${formatCurrency(data.closing)}</p></div>
                <div class="kpi-card text-center"><p class="text-sm font-medium text-gray-500">Net Income Actual (R$ '000)</p><p class="text-3xl font-bold text-blue-600">${formatCurrency(data.actual)}</p></div>
                <div class="kpi-card text-center"><p class="text-sm font-medium text-gray-500">Total Variance (R$ '000)</p><p class="text-3xl font-bold ${data.variance >= 0 ? 'value-positive' : 'value-negative'}">${formatCurrency(data.variance)}</p></div>`;
        };

        const renderTable = (tableId, headers, rows, rowRenderer) => {
            const tableEl = document.getElementById(tableId);
            tableEl.innerHTML = `
                <thead class="bg-gray-50"><tr>${headers.map(h => `<th class="px-4 py-3 text-${h.align || 'left'} text-xs font-medium text-gray-500 uppercase tracking-wider">${h.label}</th>`).join('')}</tr></thead>
                <tbody class="bg-white divide-y divide-gray-200">${rows.map(rowRenderer).join('')}</tbody>`;
        };
        
        const renderIncomeTable = (view, data) => {
            const headers = [{label: 'Income Statement'}, {label: 'Δ vs. ' + (view === 'flash' ? 'Flash Closing' : 'Forecast'), align: 'right'}, {label: 'Key Drivers'}];
            renderTable(`${view}-income-table`, headers, data, r => `<tr class="${r.isSub ? 'bg-gray-50' : ''} ${r.isTotal ? 'bg-blue-100' : ''}"><td class="px-4 py-3 ${r.isBold ? 'font-bold' : 'font-semibold'}">${r.item}</td><td class="px-4 py-3 text-right font-semibold ${r.delta.startsWith('+') ? 'value-positive' : 'value-negative'}">${r.delta}</td><td class="px-4 py-3 text-gray-600 ${r.isBold ? 'font-bold' : ''}">${r.driver}</td></tr>`);
        };

        const renderMissTable = (view, data) => {
            const headers = [{label: 'Bucket'}, {label: 'Impact', align: 'right'}, {label: 'Share of Total Variance', align: 'right'}];
            renderTable(`${view}-miss-table`, headers, data, r => `<tr><td class="px-4 py-3">${r.bucket}</td><td class="px-4 py-3 text-right ${r.impact.startsWith('+') ? 'value-positive' : 'value-negative'}">${r.impact}</td><td class="px-4 py-3 text-right">${r.share}</td></tr>`);
        };

        const renderTakeaways = (view, data) => {
            document.getElementById(`${view}-takeaways`).innerHTML = data.map(t => `<div class="p-4 rounded-lg bg-gray-50"><h3 class="font-semibold text-gray-800">${t.title}</h3><p class="mt-1 text-gray-600 text-sm">${t.text}</p></div>`).join('');
        };
        
        const renderOpMetricsCharts = (data) => {
            const containerFlash = document.getElementById('flash-op-metrics');
            const containerForecast = document.getElementById('forecast-op-metrics');
            containerFlash.innerHTML = '';
            containerForecast.innerHTML = '';

            Object.keys(data).forEach(key => {
                const metric = data[key];
                const chartId = `op-chart-${key}`;
                const chartWrapper = `<div><h3 class="text-lg font-semibold text-center text-gray-700 mb-2">${metric.label}</h3><div class="small-chart-container"><canvas id="${chartId}"></canvas></div></div>`;
                containerFlash.innerHTML += chartWrapper;
                containerForecast.innerHTML += chartWrapper.replace(chartId, `${chartId}-2`);
            });

            Object.keys(data).forEach(key => {
                createOpMetricChart(`${key}`, data[key]);
                createOpMetricChart(`${key}-2`, data[key]);
            });
        };

        const createOpMetricChart = (key, metricData) => {
            const chartId = `op-chart-${key}`;
            if (opCharts[chartId]) opCharts[chartId].destroy();
            const ctx = document.getElementById(chartId).getContext('2d');
            
            const dataPoints = [metricData.forecast, metricData.flash, metricData.actual];
            const dataMin = Math.min(...dataPoints);
            const dataMax = Math.max(...dataPoints);
            const buffer = Math.abs(dataMax - dataMin) * 0.5 || Math.abs(dataMin) * 0.2;

            opCharts[chartId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Forecast', 'Flash', 'Actual'],
                    datasets: [{
                        data: dataPoints,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: (context) => context.dataset.data[context.dataIndex] >= 0 ? 'end' : 'start',
                            align: (context) => context.dataset.data[context.dataIndex] >= 0 ? 'end' : 'start',
                            formatter: (value) => (value / 1000).toLocaleString('en-US', { maximumFractionDigits: 0 }) + 'k',
                            font: { weight: 'bold' }
                        }
                    },
                    scales: { 
                        y: { 
                            min: dataMin - buffer,
                            max: dataMax + buffer,
                            ticks: { callback: (value) => (value/1000).toLocaleString('en-US') + 'k' } 
                        } 
                    }
                }
            });
        };

        const renderAccuracyKPIs = (data) => {
            const flashContainer = document.getElementById('flash-accuracy-kpis');
            const forecastContainer = document.getElementById('forecast-accuracy-kpis');
            flashContainer.innerHTML = '';
            forecastContainer.innerHTML = '';

            Object.keys(data).forEach(key => {
                const metric = data[key];
                const flashAccuracy = metric.flash !== 0 ? (metric.actual / metric.flash * 100) : 0;
                const forecastAccuracy = metric.forecast !== 0 ? (metric.actual / metric.forecast * 100) : 0;
                
                const getColor = (acc) => acc >= 98 && acc <= 102 ? 'value-positive' : acc >= 90 && acc <= 110 ? 'text-yellow-500' : 'value-negative';

                flashContainer.innerHTML += `<div class="kpi-card text-center"><p class="text-sm font-medium text-gray-500">${metric.label}</p><p class="text-2xl font-bold ${getColor(flashAccuracy)}">${flashAccuracy.toFixed(1)}%</p></div>`;
                forecastContainer.innerHTML += `<div class="kpi-card text-center"><p class="text-sm font-medium text-gray-500">${metric.label}</p><p class="text-2xl font-bold ${getColor(forecastAccuracy)}">${forecastAccuracy.toFixed(1)}%</p></div>`;
            });
        };
        
        const createOrUpdateWaterfallChart = (chartInstance, canvasId, sourceData) => {
            let runningTotal = 0;
            const allPoints = [0];
            const chartData = sourceData.data.map(item => {
                if (item.t === 't') { allPoints.push(item.v); runningTotal = item.v; return [0, item.v]; }
                const start = runningTotal; const end = runningTotal + item.v;
                allPoints.push(end); runningTotal = end; return [start, end];
            });
            const dataMin = Math.min(...allPoints); const dataMax = Math.max(...allPoints);
            const buffer = (dataMax - dataMin) * 0.10;
            const newMax = dataMax + buffer;
            const backgroundColors = sourceData.data.map(item => item.t === 't' ? '#1f2937' : (item.v >= 0 ? '#10b981' : '#ef4444'));
            if (chartInstance) {
                chartInstance.data.datasets[0].data = chartData;
                chartInstance.options.scales.y.max = newMax;
                chartInstance.update(); return chartInstance;
            } else {
                const ctx = document.getElementById(canvasId).getContext('2d');
                return new Chart(ctx, {
                    type: 'bar',
                    data: { labels: sourceData.labels, datasets: [{ label: 'Net Income (R$)', data: chartData, backgroundColor: backgroundColors, barPercentage: 0.8 }] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, datalabels: {
                            color: '#374151',
                            anchor: (c) => c.dataset.data[c.dataIndex][0] < c.dataset.data[c.dataIndex][1] ? 'end' : 'start',
                            align: (c) => c.dataset.data[c.dataIndex][0] < c.dataset.data[c.dataIndex][1] ? 'end' : 'start',
                            offset: 4, font: { weight: '900', size: 12 },
                            formatter: (v, c) => {
                                const raw = sourceData.data[c.dataIndex];
                                if (raw.t === 'd' && Math.abs(raw.v) < 10) return null;
                                return raw.v.toLocaleString('en-US');
                            }
                        }},
                        scales: { y: { max: newMax, ticks: { callback: (value) => formatCurrency(value) } } }
                    }
                });
            }
        };

        const updateDashboard = (data) => {
            renderKPIs('flash', data.flash.kpis);
            renderIncomeTable('flash', data.flash.incomeTable);
            renderMissTable('flash', data.flash.missTable);
            renderTakeaways('flash', data.flash.takeaways);
            flashWaterfallChart = createOrUpdateWaterfallChart(flashWaterfallChart, 'flashWaterfallChart', data.flash.waterfall);
            
            renderKPIs('forecast', data.forecast.kpis);
            renderIncomeTable('forecast', data.forecast.incomeTable);
            renderMissTable('forecast', data.forecast.missTable);
            renderTakeaways('forecast', data.forecast.takeaways);
            forecastWaterfallChart = createOrUpdateWaterfallChart(forecastWaterfallChart, 'forecastWaterfallChart', data.forecast.waterfall);

            renderOpMetricsCharts(data.operational);
            renderAccuracyKPIs(data.operational);
        };
        
        const setActiveView = (view) => {
            currentView = view;
            viewFlash.classList.toggle('hidden', view !== 'flash');
            viewForecast.classList.toggle('hidden', view !== 'forecast');
            btnFlash.classList.toggle('active', view === 'flash');
            btnForecast.classList.toggle('active', view === 'forecast');
        };

        btnFlash.addEventListener('click', () => setActiveView('flash'));
        btnForecast.addEventListener('click', () => setActiveView('forecast'));
        printButton.addEventListener('click', () => {
            viewFlash.classList.remove('hidden');
            viewForecast.classList.remove('hidden');
            requestAnimationFrame(() => window.print());
        });
        window.addEventListener('afterprint', () => setActiveView(currentView));
        
        updateDashboard(initialReportData);
        setActiveView('flash');
    });
    </script>
</body>
</html>
